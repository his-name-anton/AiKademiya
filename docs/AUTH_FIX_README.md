# Исправление проблемы с аутентификацией

## Проблема
Пользователи выбрасывались из личного кабинета при обновлении страницы, несмотря на то, что токены были валидными.

## Причины проблемы
1. **Неправильная инициализация аутентификации**: Инициализация происходила в `onMounted` вместо `onBeforeMount`
2. **Плохая обработка ошибок**: При ошибках аутентификации пользователь перенаправлялся на главную страницу вместо страницы входа
3. **Бесконечные циклы**: Функция `refreshTokens` вызывала `logout()`, что могло приводить к бесконечным циклам
4. **Неправильная очистка данных**: Event listeners не очищались должным образом

## Внесенные исправления

### 1. Frontend (Vue.js)

#### App.vue
- Изменен `onMounted` на `onBeforeMount` для инициализации аутентификации до рендеринга
- Добавлена обработка ошибок с очисткой данных аутентификации

#### stores/auth.ts
- Улучшена функция `initializeAuth()` с подробным логированием
- Исправлена функция `refreshTokens()` - убрана рекурсивная очистка данных
- Улучшена функция `logout()` - добавлена проверка наличия refresh token
- Улучшена функция `clearAuthData()` - добавлена очистка всех event listeners
- Добавлено подробное логирование для отладки

#### api/client.ts
- Улучшена обработка 401 ошибок в response interceptor
- Добавлена проверка текущего пути перед редиректом
- Добавлено подробное логирование

#### router/index.ts
- Улучшена логика ожидания инициализации аутентификации
- Добавлено логирование для отладки

### 2. Backend (Django)

#### settings.py
- Увеличены сроки жизни JWT токенов:
  - Access token: 24 часа
  - Refresh token: 30 дней
- Добавлены настройки сессий для лучшей совместимости:
  - `SESSION_COOKIE_AGE = 30 * 24 * 60 * 60` (30 дней)
  - `SESSION_EXPIRE_AT_BROWSER_CLOSE = False`
  - `SESSION_SAVE_EVERY_REQUEST = True`

## Как работает исправленная система

### Инициализация приложения
1. При загрузке приложения сначала инициализируется тема
2. Затем инициализируется аутентификация (`initializeAuth()`)
3. Проверяются сохраненные токены в localStorage
4. Если access token истек, автоматически обновляется через refresh token
5. Загружается профиль пользователя для подтверждения валидности токенов
6. Устанавливаются таймеры для автоматического обновления токенов и мониторинга активности

### Автоматическое обновление токенов
- Токены обновляются за 5 минут до истечения срока действия
- При ошибке обновления пользователь перенаправляется на страницу входа
- Все API запросы автоматически используют новый токен

### Мониторинг активности
- Пользователь автоматически выходит через 24 часа неактивности
- Активность отслеживается по событиям: клики, движения мыши, нажатия клавиш, скролл
- При возвращении на вкладку таймеры сбрасываются

### Обработка ошибок
- При 401 ошибке сначала пытается обновить токен
- Если обновление не удалось, пользователь выходит из системы
- Редирект происходит только если пользователь не на странице входа или главной

## Тестирование

Создан файл `test-auth.html` для тестирования API аутентификации:

1. Откройте файл в браузере
2. Нажмите "Тест входа" для авторизации
3. Проверьте статус аутентификации
4. Обновите страницу - статус должен сохраниться
5. Используйте другие кнопки для тестирования различных функций

## Рекомендации для продакшена

1. **HTTPS**: Включите `SESSION_COOKIE_SECURE = True` при использовании HTTPS
2. **Логирование**: Настройте proper logging для отслеживания проблем аутентификации
3. **Мониторинг**: Добавьте мониторинг количества неудачных попыток обновления токенов
4. **Rate Limiting**: Добавьте ограничения на количество запросов обновления токенов
5. **Аудит**: Логируйте все события входа/выхода для безопасности

## Проверка исправления

После внесения изменений:

1. Запустите приложение
2. Войдите в личный кабинет
3. Обновите страницу (F5 или Ctrl+R)
4. Убедитесь, что вы остались в личном кабинете
5. Проверьте, что токены автоматически обновляются
6. Проверьте, что выход происходит только через 24 часа неактивности или при явном выходе